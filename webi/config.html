<!DOCTYPE html>
<html lang='cz'>
<head>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Kegator - nastavení</title>
    <link rel="stylesheet" type="text/css" href="sass/style.css">

    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
    <link rel="manifest" href="img/site.webmanifest">
    <meta name="msapplication-TileColor" content="#feda3e">
    <meta name="theme-color" content="#feda3e">
    <script>

var keg = false;

function load() {
	const url = "conf.json";
	fetch(url)
	.then(response => {
		if (!response.ok)
			throw new Error("Network response was not ok");
		return response.json();
	})
	.then(data => {
		if ('ssid' in data) {
        	document.getElementById("wifi_ssid").value = data.ssid;
        	document.getElementById("wifi_pwd").placeholder = "******";
    	}
    })
    .catch(error => {
    	console.error("Error loading conf.json:", error);
    });

	const url2 = "data.json";
	fetch(url2)
    .then(response => {
	if (!response.ok) throw new Error("Network response was not ok");
		return response.json();
	})
	.then(data => {
		if ('sw' in data) {
        	document.getElementById("fw_version").innerHTML = data.sw;
      	}
    })
    .catch(error => {
		console.error("Error loading data.json:", error);
	});
}

function save(geto) {
	const gkeys = Object.keys(geto);
	const glen = gkeys.length;

	if (glen === 0) {
    	alert('Není co nastavovat!');
    	return;
	}

  	// Připravit data pro POST
	const formData = new FormData();
	for (const key of gkeys) {
    	formData.append(key, geto[key]);
	}

	fetch('do.php', {
    	method: 'POST',
    	body: formData
	})
    .then(response => {
		if (!response.ok)
			throw new Error('Network response was not ok');
		return response.text();
	})
    .then(data => {
    	if (data === 'OK') {
        	alert('Nastavení OK');
        	//load(); // pokud chceš znovu načíst data
        	window.location.href = 'config.html';
		}
    })
    .catch(error => {
		console.error('Error saving settings:', error);
    });
}

	</script>
</head>
<body onload="load();" class="b-config">
    <main>
        <div class="container">
            <div class="top">
                <h1>Nastavení</h1>
            </div>
            <div class="form">
		<h2>Síť v lokále</h2>
                <p class="line">
                    <label for="wifi_ssid">Jméno sítě</label>
                    <input id='wifi_ssid' class="field" placeholder='pivniGaraz'/>

                </p>
                <p class="line">
                    <label for="wifi_pwd">Přihlašovací heslo</label>
                    <input  id='wifi_pwd' class="field" placeholder='123456'/>
                </p>
                <p class="btns">
                    <button id='save_ssid' class="btn">Potvrdit</button>
                </p>
		<p class="btns">
		    <button id='rem_ssid' class="btn">Odstranit</button>
		</p>
            </div>
	    <div class="form">
		    <h2>Váš Kegator &reg; nyní disponuje firmwarem <span id="fw_version">neznámým</span></h2>
	    </div>
	    <p class="btns">
                <button id='cancel' class="btn">Hotovo</button>
	    </p>

	</div>
    </main>

    <script>

document.addEventListener("DOMContentLoaded", function() {

	// Uložit WiFi SSID
	document.getElementById("save_ssid").addEventListener("click", function() {
    	const geto = {};
    	const name = document.getElementById("wifi_ssid").value;
    	if (name !== undefined && name !== "") {
      		geto['wssid'] = name;
      		let pwd = document.getElementById("wifi_pwd").value;
      		if (pwd === undefined || pwd === "")
				pwd = '';
      		geto['wpwd'] = pwd;
    	}
    	save(geto);
  	});

  	// Odstranit WiFi SSID
  	document.getElementById("rem_ssid").addEventListener("click", function() {
    	const geto = {
      		wssid: "",
      		wpwd: ""
    	};
    	save(geto);
  	});

  	// Zrušit / návrat na index
  	document.getElementById("cancel").addEventListener("click", function() {
    	window.location.href = 'index.html';
  	});
});

	</script>
</body>
</html>
