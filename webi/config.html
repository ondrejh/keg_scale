<!DOCTYPE html>
<html lang='cz'>
<head>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Kegator - nastavení</title>
    <link rel="stylesheet" type="text/css" href="sass/style.css">

    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
    <link rel="manifest" href="img/site.webmanifest">
    <meta name="msapplication-TileColor" content="#feda3e">
    <meta name="theme-color" content="#feda3e">
    <script>

var keg = false;

function load() {
	const url = "conf.json";
	fetch(url)
	.then(response => {
		if (!response.ok)
			throw new Error("Network response was not ok");
		return response.json();
	})
	.then(data => {
		if ('ssid' in data) {
        	document.getElementById("wifi_ssid").value = data.ssid;
        	document.getElementById("wifi_pwd").placeholder = "******";
    	}
		if ('mqtt_url' in data)
			document.getElementById("mqtt_url").value = data.mqtt_url;
		if ('mqtt_topic' in data)
			document.getElementById("mqtt_topic").value = data.mqtt_topic;
		if ('mqtt_user' in data) {
			document.getElementById("mqtt_user").value = data.mqtt_user;
			document.getElementById("mqtt_pass").placeholder = "******";
		}
    })
    .catch(error => {
    	console.error("Error loading conf.json:", error);
    });

	const url2 = "data.json";
	fetch(url2)
    .then(response => {
	if (!response.ok) throw new Error("Network response was not ok");
		return response.json();
	})
	.then(data => {
		if ('sw' in data) {
        	document.getElementById("fw_version").innerHTML = data.sw;
      	}
    })
    .catch(error => {
		console.error("Error loading data.json:", error);
	});
}

function save(geto) {
	const gkeys = Object.keys(geto);
	const glen = gkeys.length;

	if (glen === 0) {
    	alert('Není co nastavovat!');
    	return;
	}

  	// Připravit data pro POST
	const formData = new FormData();
	for (const key of gkeys) {
    	formData.append(key, geto[key]);
	}

	fetch('do.php', {
    	method: 'POST',
    	body: formData
	})
    .then(response => {
		if (!response.ok)
			throw new Error('Network response was not ok');
		return response.text();
	})
    .then(data => {
    	if (data === 'OK') {
        	alert('Nastavení OK');
        	//load(); // pokud chceš znovu načíst data
        	window.location.href = 'config.html';
		}
    })
    .catch(error => {
		console.error('Error saving settings:', error);
    });
}

	</script>
</head>
<body onload="load();" class="b-config">
    <main>
        <div class="container">
            <div class="top">
                <h1>Nastavení</h1>
            </div>
            <div class="form">
				<h2>Přihlášení do sítě v lokále</h2>
                <p class="line">
                    <label for="wifi_ssid">Jméno sítě</label>
                    <input id='wifi_ssid' class="field" placeholder='pivniGaraz'/>
                </p>
                <p class="line">
                    <label for="wifi_pwd">Přihlašovací heslo</label>
                    <input  id='wifi_pwd' class="field" placeholder='123456'/>
                </p>
                <p class="btns">
                    <button id='save_ssid' class="btn">Potvrdit</button>
                </p>
				<p class="btns">
		    		<button id='rem_ssid' class="btn">Odstranit</button>
				</p>
            </div>
			<div class="form">
				<h2>Odesílání na MQTT server</h2>
				<p class="line">
					<label for="mqtt_url">Adresa serveru</label>
					<input id="mqtt_url" class="field" placeholder="http://homeassistant.local"/>
				</p>
				<p class="line">
					<label for="mqtt_topic">Topic</label>
					<input id="mqtt_topic" class="field" placeholder="home/keg"/>
				</p>
				<p class="line">
					<label for="mqtt_user">Login</label>
					<input id="mqtt_user" class="field" placeholder="Franta"/>
				</p>
				<p class="line">
					<label for="mqtt_pass">Heslo</label>
					<input id="mqtt_pass" class="field" placehoder="654321"/>
				</p>
				<p class="btns">
					<button id="save_mqtt" class="btn">Potvrdit</button>
				</p>
				<p class="btns">
					<button id="rem_mqtt" class="btn">Odstranit</button>
				</p>
			</div>
	    	<div class="form">
		    	<h2>Váš Kegator &reg; nyní disponuje firmwarem <span id="fw_version">neznámým</span></h2>
	    	</div>
	    	<p class="btns">
            	<button id='cancel' class="btn">Hotovo</button>
	    	</p>
		</div>
    </main>

    <script>

document.addEventListener("DOMContentLoaded", function() {

	// Uložit MQTT
	document.getElementById("save_mqtt").addEventListener("click", function() {
    	const geto = {};
    	const mqtt_url = document.getElementById("mqtt_url").value;
    	if ((mqtt_url !== undefined) && (mqtt_url !== ""))
      		geto['mqtt_url'] = mqtt_url;
    	const mqtt_topic = document.getElementById("mqtt_topic").value;
		if ((mqtt_topic !== undefined) && (mqtt_topic !== ""))
			geto['mqtt_topic'] = mqtt_topic;
		const mqtt_user = document.getElementById("mqtt_user").value;
		if ((mqtt_user !== undefined) && (mqtt_user !== "")) {
			geto['mqtt_user'] = mqtt_user;
			const mqtt_pass = document.getElementById("mqtt_pass").value;
			if ((mqtt_pass === undefined) || (mqtt_pass === ""))
				mqtt_pass = "";
			geto['mqtt_pass'] = mqtt_pass;
		};
    	save(geto);
  	});

	// Odstranit MQTT
	document.getElementById("rem_mqtt").addEventListener("click", function() {
		const geto = {
			mqtt_url: "",
			mqtt_topic: "",
			mqtt_user: "",
			mqtt_pass: ""
		};
    	save(geto);
	});

	// Uložit WiFi SSID
	document.getElementById("save_ssid").addEventListener("click", function() {
    	const geto = {};
    	const name = document.getElementById("wifi_ssid").value;
    	if (name !== undefined && name !== "") {
      		geto['wssid'] = name;
      		let pwd = document.getElementById("wifi_pwd").value;
      		if (pwd === undefined || pwd === "")
				pwd = '';
      		geto['wpwd'] = pwd;
    	};
    	save(geto);
  	});

  	// Odstranit WiFi SSID
  	document.getElementById("rem_ssid").addEventListener("click", function() {
    	const geto = {
      		wssid: "",
      		wpwd: ""
    	};
    	save(geto);
  	});

  	// Zrušit / návrat na index
  	document.getElementById("cancel").addEventListener("click", function() {
    	window.location.href = 'index.html';
  	});
});

	</script>
</body>
</html>
